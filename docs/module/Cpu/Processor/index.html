<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Processor (gbcamel.Cpu.Processor)</title><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">gbcamel</a> &#x00BB; <a href="../index.html">Cpu</a> &#x00BB; Processor</nav><header class="odoc-preamble"><h1>Module <code><span>Cpu.Processor</span></code></h1><p>processor.ml - CPU logic</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-processor"><a href="#type-processor" class="anchor"></a><code><span><span class="keyword">type</span> processor</span><span> = </span><span>{</span></code><ol><li id="type-processor.regs" class="def record field anchored"><a href="#type-processor.regs" class="anchor"></a><code><span>regs : <a href="../Registers/index.html#type-registers">Registers.registers</a>;</span></code></li><li id="type-processor.mem" class="def record field anchored"><a href="#type-processor.mem" class="anchor"></a><code><span>mem : <a href="../../Memory/Vmem/index.html#type-mem_ctrl">Memory.Vmem.mem_ctrl</a>;</span></code></li><li id="type-processor.ih" class="def record field anchored"><a href="#type-processor.ih" class="anchor"></a><code><span>ih : <a href="../Interrupts/index.html#type-interrupt_handler">Interrupts.interrupt_handler</a>;</span></code></li><li id="type-processor.halted" class="def record field anchored"><a href="#type-processor.halted" class="anchor"></a><code><span>halted : <span>bool <span class="xref-unresolved">Stdlib</span>.ref</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Emulates CPU state</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-_init_processor"><a href="#val-_init_processor" class="anchor"></a><code><span><span class="keyword">val</span> _init_processor : <span><a href="../../Memory/Vmem/index.html#type-mem_ctrl">Memory.Vmem.mem_ctrl</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-processor">processor</a></span></code></div><div class="spec-doc"><p>Returns an initialized CPU state</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_byte"><a href="#val-read_byte" class="anchor"></a><code><span><span class="keyword">val</span> read_byte : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> char</span></code></div><div class="spec-doc"><p>Read the next byte at position (PC) and increment PC</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_word"><a href="#val-read_word" class="anchor"></a><code><span><span class="keyword">val</span> read_word : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Read the next word (2 bytes) at position (PC) and increment PC twice</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_flag_set"><a href="#val-is_flag_set" class="anchor"></a><code><span><span class="keyword">val</span> is_flag_set : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if a specific flag is set in the F register</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_flag_set_b"><a href="#val-is_flag_set_b" class="anchor"></a><code><span><span class="keyword">val</span> is_flag_set_b : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Check if a specific flag is set in the F register - returns an int</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_flag"><a href="#val-set_flag" class="anchor"></a><code><span><span class="keyword">val</span> set_flag : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Set a flag in the F register</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rp_table_read"><a href="#val-rp_table_read" class="anchor"></a><code><span><span class="keyword">val</span> rp_table_read : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="../Registers/index.html#type-registers">Registers.registers</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Utils/U16/index.html#type-u16">Utils.U16.u16</a></span></code></div><div class="spec-doc"><p>Get the register read function corresponding to rp<code>n</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rp_table_write"><a href="#val-rp_table_write" class="anchor"></a><code><span><span class="keyword">val</span> rp_table_write : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="../Registers/index.html#type-registers">Registers.registers</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Get the register write function corresponding to rp<code>n</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-r_table_read"><a href="#val-r_table_read" class="anchor"></a><code><span><span class="keyword">val</span> r_table_read : 
  <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  int * <span>(<span><a href="../Registers/index.html#type-registers">Registers.registers</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Utils/U8/index.html#type-u8">Utils.U8.u8</a>)</span></span></code></div><div class="spec-doc"><p>Get the register read function corresponding to r[n]</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-r_table_write"><a href="#val-r_table_write" class="anchor"></a><code><span><span class="keyword">val</span> r_table_write : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>char <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Get the register write function corresponding to r<code>n</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-push"><a href="#val-push" class="anchor"></a><code><span><span class="keyword">val</span> push : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Push 16 bits onto the stack</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-push_rp2"><a href="#val-push_rp2" class="anchor"></a><code><span><span class="keyword">val</span> push_rp2 : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Push 16 bits onto the stack from a set register in the RP2 table</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pop"><a href="#val-pop" class="anchor"></a><code><span><span class="keyword">val</span> pop : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Pop 16 bits from the stack</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pop_rp2"><a href="#val-pop_rp2" class="anchor"></a><code><span><span class="keyword">val</span> pop_rp2 : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Pop 16 bits from the stack and load them into a set register in the RP2 table</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-nop"><a href="#val-nop" class="anchor"></a><code><span><span class="keyword">val</span> nop : <span>unit <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>No-operation</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-stop"><a href="#val-stop" class="anchor"></a><code><span><span class="keyword">val</span> stop : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-halt"><a href="#val-halt" class="anchor"></a><code><span><span class="keyword">val</span> halt : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Halts the CPU</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-jp"><a href="#val-jp" class="anchor"></a><code><span><span class="keyword">val</span> jp : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Unconditional jump</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-jr"><a href="#val-jr" class="anchor"></a><code><span><span class="keyword">val</span> jr : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Unconditional relative jump</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-jp_cond"><a href="#val-jp_cond" class="anchor"></a><code><span><span class="keyword">val</span> jp_cond : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Conditional jump</p><p>jp_cond <code>cpu</code> <code>cond</code> <code>address</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-jr_cond"><a href="#val-jr_cond" class="anchor"></a><code><span><span class="keyword">val</span> jr_cond : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Conditional relative jump</p><p>jr_cond <code>cpu</code> <code>cond</code> <code>offset</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-call"><a href="#val-call" class="anchor"></a><code><span><span class="keyword">val</span> call : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Call</p><p>call <code>cpu</code> <code>new_pc</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-call_cond"><a href="#val-call_cond" class="anchor"></a><code><span><span class="keyword">val</span> call_cond : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Conditional call</p><p>call <code>cpu</code> <code>new_pc</code> <code>cond</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ret"><a href="#val-ret" class="anchor"></a><code><span><span class="keyword">val</span> ret : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Return</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ret_cond"><a href="#val-ret_cond" class="anchor"></a><code><span><span class="keyword">val</span> ret_cond : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Conditional return</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rst"><a href="#val-rst" class="anchor"></a><code><span><span class="keyword">val</span> rst : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Restart</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add16"><a href="#val-add16" class="anchor"></a><code><span><span class="keyword">val</span> add16 : <span><span>int <span class="xref-unresolved">Stdlib</span>.ref</span> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>(dest += src)%u16</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-alu"><a href="#val-alu" class="anchor"></a><code><span><span class="keyword">val</span> alu : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Utils/U8/index.html#type-u8">Utils.U8.u8</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>ALU table</p><p>alu <code>cpu</code> <code>table_idx</code> <code>operand</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rotate_left"><a href="#val-rotate_left" class="anchor"></a><code><span><span class="keyword">val</span> rotate_left : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>char <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> char</span></code></div><div class="spec-doc"><p>Leftward bit-rotation operation</p><p>rotate_left <code>cpu</code> <code>to_rotate</code> <code>include_carry</code> <code>update_zero</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rotate_right"><a href="#val-rotate_right" class="anchor"></a><code><span><span class="keyword">val</span> rotate_right : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>char <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> char</span></code></div><div class="spec-doc"><p>Rightward bit-rotation operation</p><p>rotate_right <code>cpu</code> <code>to_rotate</code> <code>include_carry</code> <code>update_zero</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shift_left"><a href="#val-shift_left" class="anchor"></a><code><span><span class="keyword">val</span> shift_left : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>char <span class="arrow">&#45;&gt;</span></span> char</span></code></div><div class="spec-doc"><p>Left bitshift</p><p>shift_left <code>cpu</code> <code>to_shift</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shift_right"><a href="#val-shift_right" class="anchor"></a><code><span><span class="keyword">val</span> shift_right : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>char <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> char</span></code></div><div class="spec-doc"><p>Right bitshift</p><p>shift_left <code>cpu</code> <code>to_shift</code> <code>keep_msb</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-swap"><a href="#val-swap" class="anchor"></a><code><span><span class="keyword">val</span> swap : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>char <span class="arrow">&#45;&gt;</span></span> char</span></code></div><div class="spec-doc"><p>Swaps the highest MSBs and lowest MSBs</p><p>swap <code>cpu</code> <code>to_swap</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bit"><a href="#val-bit" class="anchor"></a><code><span><span class="keyword">val</span> bit : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>char <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Test a bit bit <code>cpu</code> <code>value</code> <code>bit_to_test</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set"><a href="#val-set" class="anchor"></a><code><span><span class="keyword">val</span> set : <span>char <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> char</span></code></div><div class="spec-doc"><p>Set a bit (just <code>value | bit</code>)</p><p>set <code>cpu</code> <code>value</code> <code>bit</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-res"><a href="#val-res" class="anchor"></a><code><span><span class="keyword">val</span> res : <span>char <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> char</span></code></div><div class="spec-doc"><p>Reset a bit</p><p>res <code>cpu</code> <code>value</code> <code>bit</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rot"><a href="#val-rot" class="anchor"></a><code><span><span class="keyword">val</span> rot : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Rotation table ROT</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-decode_execute"><a href="#val-decode_execute" class="anchor"></a><code><span><span class="keyword">val</span> decode_execute : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> <span>char <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>General decoder</p><p>Layout is based on <a href="https://gb-archive.github.io/salvage/decoding_gbz80_opcodes/Decoding%20Gamboy%20Z80%20Opcodes.html">this table</a></p><p>Returns the number of cycles taken to execute the provided instruction</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-de_step"><a href="#val-de_step" class="anchor"></a><code><span><span class="keyword">val</span> de_step : <span><a href="#type-processor">processor</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Performs one step of the decode-execute cycle</p></div></div></div></body></html>